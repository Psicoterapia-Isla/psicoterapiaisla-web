<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vista terapeuta | Psicoterapia Isla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">

  <!-- MENÚ DINÁMICO -->
  <nav id="app-menu" class="app-menu"></nav>

  <main class="app-container">
    <h1>Entradas – Vista terapeuta</h1>

    <!-- FILTROS -->
    <div class="filters">
      <input type="text" id="filter-uid" placeholder="UID del paciente">

      <select id="filter-type">
        <option value="">Todos los ejercicios</option>
        <option value="diario">Diario</option>
        <option value="registro_emocional">Registro emocional</option>
        <option value="sentirme_a_salvo">Sentirme a salvo</option>
        <option value="autocompasion">Autocompasión</option>
        <option value="limites">Límites</option>
        <option value="recursos_internos">Recursos internos</option>
      </select>

      <button id="filter-btn">Filtrar</button>
    </div>

    <hr>

    <div id="entries-list"></div>
  </main>

  <script type="module">
    import { requireAuth } from "./assets/js/auth.js";
    import { loadMenu } from "./assets/js/menu.js";
    import { auth, db } from "./assets/js/firebase.js";
    import {
      collection,
      query,
      where,
      orderBy,
      getDocs,
      getDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    requireAuth();

    /* ---------- CARGA MENÚ (ROL) ---------- */
    (async () => {
      const userDoc = await getDoc(doc(db, "users", auth.currentUser.uid));
      const role = userDoc.data()?.role || "patient";
      loadMenu(role);
    })();

    const container = document.getElementById("entries-list");
    const filterUidInput = document.getElementById("filter-uid");
    const filterTypeSelect = document.getElementById("filter-type");
    const filterBtn = document.getElementById("filter-btn");

    /* ---------- LOAD ENTRIES ---------- */
    async function loadEntriesFiltered(uid, type) {
      container.innerHTML = "<p>Cargando…</p>";

      const constraints = [];

      if (uid) constraints.push(where("uid", "==", uid));
      if (type) constraints.push(where("type", "==", type));

      constraints.push(orderBy("createdAt", "desc"));

      const q = query(collection(db, "entries"), ...constraints);
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        container.innerHTML = "<p>No hay resultados.</p>";
        return;
      }

      container.innerHTML = "";

      snapshot.forEach(docSnap => {
        const d = docSnap.data();

        container.innerHTML += `
          <div class="entry-card">
            <small><strong>Paciente:</strong> ${d.uid}</small><br>
            <small>${d.createdAt?.toDate().toLocaleString()}</small>
            <p><strong>${d.type}</strong></p>
            <pre>${d.texto || JSON.stringify(d.data || {}, null, 2)}</pre>
            <hr>
          </div>
        `;
      });
    }

    /* ---------- FILTRAR ---------- */
    filterBtn.addEventListener("click", () => {
      const uid = filterUidInput.value.trim();
      const type = filterTypeSelect.value;
      loadEntriesFiltered(uid, type);
    });
  </script>

</body>
</html>
