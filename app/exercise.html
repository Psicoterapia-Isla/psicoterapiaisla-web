<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ejercicio terap√©utico | Psicoterapia Isla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS base -->
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">

<header class="app-menu"></header>

<main class="app-container">

  <!-- T√çTULO -->
  <h1 id="exercise-title"></h1>

  <!-- DESCRIPCI√ìN -->
  <p id="exercise-description" style="opacity:.8; margin-bottom:24px;"></p>

  <!-- FORMULARIO -->
  <section class="card">
    <form id="exercise-form"></form>
  </section>

</main>

<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { loadMenu } from "./assets/js/menu.js";
  import { db, auth } from "./assets/js/firebase.js";

  import {
    doc,
    getDoc,
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // üîê Auth + men√∫
  await requireAuth();
  await loadMenu();

  // üìå ID del ejercicio
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    alert("Ejercicio no especificado");
    window.location.href = "index.html";
  }

  // üì• Cargar ejercicio
  const ref = doc(db, "exercises", id);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("Ejercicio no encontrado");
    window.location.href = "index.html";
  }

  const exercise = snap.data();

  // üñäÔ∏è Pintar contenido
  document.getElementById("exercise-title").textContent = exercise.title;
  document.getElementById("exercise-description").textContent =
    exercise.description || "";

  const form = document.getElementById("exercise-form");

  // üß© Campos din√°micos
  exercise.fields.forEach(field => {
    const wrapper = document.createElement("div");
    wrapper.style.marginBottom = "16px";

    const label = document.createElement("label");
    label.textContent = field.replace(/_/g, " ");

    const textarea = document.createElement("textarea");
    textarea.name = field;
    textarea.required = true;
    textarea.placeholder = "Escribe aqu√≠‚Ä¶";

    wrapper.appendChild(label);
    wrapper.appendChild(textarea);
    form.appendChild(wrapper);
  });

  // üíæ Bot√≥n guardar
  const submitBtn = document.createElement("button");
  submitBtn.type = "submit";
  submitBtn.className = "btn-primary";
  submitBtn.textContent = "Guardar ejercicio";
  form.appendChild(submitBtn);

  // üì§ Guardar respuesta
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {};
    exercise.fields.forEach(field => {
      data[field] = form.elements[field].value.trim();
    });

    await addDoc(collection(db, "entries"), {
      uid: auth.currentUser.uid,
      exerciseId: id,
      exerciseTitle: exercise.title,
      data,
      createdAt: serverTimestamp()
    });

    alert("Ejercicio guardado correctamente");
    window.location.href = "index.html";
  });
</script>

</body>
</html>
