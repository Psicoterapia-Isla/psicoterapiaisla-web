<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ejercicio terapéutico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">

<header class="app-menu"></header>

<main class="app-container">
  <h1 id="exercise-title"></h1>
  <p id="exercise-description"></p>

  <form id="exercise-form"></form>
</main>

<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { db, auth } from "./assets/js/firebase.js";
  import {
    doc,
    getDoc,
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // 1️⃣ Autenticación
  await requireAuth();

  // 2️⃣ Obtener ID del ejercicio desde la URL
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if (!id) {
    alert("Ejercicio no especificado");
    window.location.href = "index.html";
  }

  // 3️⃣ Cargar ejercicio por DOCUMENT ID
  const ref = doc(db, "exercises", id);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    alert("Ejercicio no encontrado");
    window.location.href = "index.html";
  }

  const exercise = snap.data();

  // 4️⃣ Pintar título y descripción
  document.getElementById("exercise-title").textContent = exercise.title;
  document.getElementById("exercise-description").textContent = exercise.description || "";

  const form = document.getElementById("exercise-form");

  // 5️⃣ Generar campos dinámicos
  exercise.fields.forEach(field => {
    const label = document.createElement("label");
    label.textContent = field.replace(/_/g, " ");

    const textarea = document.createElement("textarea");
    textarea.name = field;
    textarea.required = true;
    textarea.placeholder = "Escribe aquí…";

    label.appendChild(textarea);
    form.appendChild(label);
  });

  // 6️⃣ Botón guardar
  const submitBtn = document.createElement("button");
  submitBtn.type = "submit";
  submitBtn.textContent = "Guardar ejercicio";
  form.appendChild(submitBtn);

  // 7️⃣ Guardar respuesta del paciente
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = {};
    exercise.fields.forEach(field => {
      data[field] = form.elements[field].value.trim();
    });

    await addDoc(collection(db, "entries"), {
      uid: auth.currentUser.uid,
      exerciseId: id,
      exerciseTitle: exercise.title,
      data,
      createdAt: serverTimestamp()
    });

    alert("Ejercicio guardado correctamente");
    window.location.href = "index.html";
  });
</script>

</body>
</html>
