<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agenda diaria | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="agenda-wrapper">
  <div class="day-header">
    <div>
      <strong id="dayLabel"></strong>
    </div>
    <button id="btnNew" class="btn-primary">ï¼‹ Nueva cita</button>
  </div>

  <div id="agendaList"></div>
</main>

<!-- MODAL -->
<div id="createModal" class="modal">
  <div class="modal-card">
    <h3>Nueva cita</h3>

    <label>Paciente</label>
    <input id="cPatientName">

    <label>Modalidad</label>
    <select id="cModality"></select>

    <label>Hora</label>
    <input id="cHour" disabled>

    <button id="cSave" class="btn-primary">Guardar</button>
    <button onclick="closeCreateModal()">Cancelar</button>
  </div>
</div>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, addDoc, getDoc, doc, Timestamp, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();
await loadMenu();

const dateISO = new URLSearchParams(location.search).get("date")
  || new Date().toISOString().slice(0,10);

const baseDate = new Date(dateISO);
baseDate.setHours(0,0,0,0);

dayLabel.textContent = baseDate.toLocaleDateString("es-ES",
  { weekday:"long", day:"numeric", month:"long" });

const therapistId = auth.currentUser.uid;

/* === DISPONIBILIDAD === */
const monday = new Date(baseDate);
monday.setDate(baseDate.getDate() - ((baseDate.getDay()+6)%7));
const weekKey = monday.toISOString().slice(0,10);

const availabilitySnap = await getDoc(
  doc(db,"availability",`${therapistId}_${weekKey}`)
);
const availability = availabilitySnap.exists()
  ? availabilitySnap.data().slots || {}
  : {};

function slotKey(hour){
  const d = ["sun","mon","tue","wed","thu","fri","sat"];
  return `${d[baseDate.getDay()]}_${hour}`;
}

/* === UI === */
const agendaList = document.getElementById("agendaList");
for(let h=9; h<21; h++){
  const key = slotKey(h);
  const avail = availability[key];

  const div = document.createElement("div");
  div.className = "slot " + (avail ? "slot-green":"slot-grey");
  div.textContent = `${h}:00`;

  if(avail){
    div.onclick = ()=>openCreateModal(h, avail);
  }
  agendaList.appendChild(div);
}

/* === MODAL === */
let selectedHour = null;
let selectedAvail = null;

window.closeCreateModal = () =>
  createModal.style.display="none";

function openCreateModal(hour, avail){
  selectedHour = hour;
  selectedAvail = avail;

  cHour.value = `${hour}:00`;

  cModality.innerHTML = "";
  Object.keys(avail).forEach(m=>{
    if(avail[m]){
      const o=document.createElement("option");
      o.value=m;
      o.textContent=m;
      cModality.appendChild(o);
    }
  });

  createModal.style.display="block";
}

cSave.onclick = async ()=>{
  const modality = cModality.value;
  if(!selectedAvail[modality]){
    alert("Modalidad no disponible");
    return;
  }

  const start = new Date(baseDate);
  start.setHours(selectedHour,0,0,0);
  const end = new Date(start);
  end.setHours(start.getHours()+1);

  await addDoc(collection(db,"appointments"),{
    therapistId,
    patientName: cPatientName.value,
    modality,
    start: Timestamp.fromDate(start),
    end: Timestamp.fromDate(end),
    status:"scheduled",
    createdAt: serverTimestamp()
  });

  location.reload();
};
</script>
</body>
</html>
