<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi espacio | Psicoterapia Isla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-layout">

<aside class="app-menu"></aside>

<main class="app-content">

  <!-- ======================
       SALUDO
  ====================== -->
  <section class="card">
    <h1 id="welcome"></h1>
    <p class="muted">
      Este es tu espacio personal de seguimiento terapéutico.
    </p>
  </section>

  <!-- ======================
       ÚLTIMAS ENTRADAS
  ====================== -->
  <section class="card">
    <h2>Últimas entradas en tu diario</h2>
    <div id="last-diary"></div>

    <a href="mi-diario.html" class="btn-secondary" style="margin-top:12px;">
      Ver todo mi diario
    </a>
  </section>

  <!-- ======================
       EJERCICIOS
  ====================== -->
  <section class="card">
    <h2>Ejercicios terapéuticos</h2>
    <div id="pending-exercises"></div>

    <a href="exercises-list.html" class="btn-primary" style="margin-top:12px;">
      Ir a ejercicios
    </a>
  </section>

  <!-- ======================
       FORO
  ====================== -->
  <section class="card">
    <h2>Espacio compartido</h2>
    <p>
      Puedes participar en el foro y leer experiencias de otras personas.
    </p>

    <a href="foro.html" class="btn-secondary">
      Entrar al foro
    </a>
  </section>

</main>

<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { loadMenu } from "./assets/js/menu.js";
  import { db } from "./assets/js/firebase.js";

  import {
    doc,
    getDoc,
    collection,
    query,
    where,
    orderBy,
    limit,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  async function init() {
    const user = await requireAuth();
    await loadMenu();

    /* ======================
       DATOS USUARIO
    ====================== */
    const userSnap = await getDoc(doc(db, "users", user.uid));
    const u = userSnap.exists() ? userSnap.data() : {};
    const name = u.alias || u.nombre || "Bienvenida";

    document.getElementById("welcome").textContent =
      `Hola, ${name}`;

    /* ======================
       ÚLTIMOS DIARIOS
    ====================== */
    const diaryBox = document.getElementById("last-diary");

    const diaryQ = query(
      collection(db, "entries"),
      where("uid", "==", user.uid),
      where("type", "==", "diario"),
      orderBy("createdAt", "desc"),
      limit(3)
    );

    const diarySnap = await getDocs(diaryQ);

    if (diarySnap.empty) {
      diaryBox.innerHTML = "<p class='muted'>Aún no has escrito en tu diario.</p>";
    } else {
      diarySnap.forEach(d => {
        const e = d.data();
        const fecha = e.createdAt?.toDate
          ? e.createdAt.toDate().toLocaleDateString()
          : "";

        const item = document.createElement("p");
        item.innerHTML = `
          <strong>${fecha}</strong><br>
          ${e.texto || e.text || ""}
        `;
        diaryBox.appendChild(item);
      });
    }

    /* ======================
       EJERCICIOS ACTIVOS
    ====================== */
    const exercisesBox = document.getElementById("pending-exercises");

    const exQ = query(
      collection(db, "exercises"),
      where("active", "==", true),
      orderBy("createdAt", "desc"),
      limit(3)
    );

    const exSnap = await getDocs(exQ);

    if (exSnap.empty) {
      exercisesBox.innerHTML = "<p class='muted'>No hay ejercicios activos.</p>";
    } else {
      exSnap.forEach(d => {
        const ex = d.data();
        const div = document.createElement("p");
        div.innerHTML = `<strong>${ex.title}</strong>`;
        exercisesBox.appendChild(div);
      });
    }
  }

  init();
</script>

</body>
</html>
