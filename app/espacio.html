<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi espacio | Psicoterapia Isla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">

<header class="app-menu"></header>

<main class="app-container">

  <!-- SALUDO -->
  <section id="welcome" class="card"></section>

  <!-- RESUMEN -->
  <section class="card">
    <h2>Resumen</h2>
    <div id="summary"></div>
  </section>

  <!-- DIARIO -->
  <section class="card">
    <h2>Últimas entradas del diario</h2>
    <div id="last-entries"></div>
    <a href="mi-diario.html" class="btn-secondary">Ver mi diario</a>
  </section>

  <!-- EJERCICIOS -->
  <section class="card">
    <h2>Ejercicios terapéuticos</h2>
    <div id="exercises"></div>
    <a href="exercises-list.html" class="btn-primary">Ver ejercicios</a>
  </section>

  <!-- FORO -->
  <section class="card">
    <h2>Foro</h2>
    <div id="forum-suggestions"></div>
    <a href="foro.html" class="btn-secondary">Ir al foro</a>
  </section>

</main>

<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { loadMenu } from "./assets/js/menu.js";
  import { db } from "./assets/js/firebase.js";

  import {
    doc,
    getDoc,
    collection,
    query,
    where,
    orderBy,
    limit,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  async function init() {
    const user = await requireAuth();
    await loadMenu();

    const userSnap = await getDoc(doc(db, "users", user.uid));
    const userData = userSnap.data();

    renderWelcome(userData);

    loadSummary(user.uid);
    loadLastEntries(user.uid);
    loadExercises();
    loadForumSuggestions();
  }

  /* ======================
     SALUDO
  ====================== */
  function renderWelcome(user) {
    document.getElementById("welcome").innerHTML = `
      <h1>Hola, ${user.name || "bienvenida"}</h1>
      <p>Este es tu espacio personal y seguro.</p>
    `;
  }

  /* ======================
     RESUMEN
  ====================== */
  async function loadSummary(uid) {
    const entriesSnap = await getDocs(
      query(
        collection(db, "entries"),
        where("uid", "==", uid)
      )
    );

    document.getElementById("summary").innerHTML = `
      <p><strong>Ejercicios realizados:</strong> ${entriesSnap.size}</p>
    `;
  }

  /* ======================
     DIARIO
  ====================== */
  async function loadLastEntries(uid) {
    const container = document.getElementById("last-entries");

    const snap = await getDocs(
      query(
        collection(db, "entries"),
        where("uid", "==", uid),
        orderBy("createdAt", "desc"),
        limit(3)
      )
    );

    if (snap.empty) {
      container.innerHTML = "<p>Aún no has escrito en tu diario.</p>";
      return;
    }

    snap.forEach(docSnap => {
      const e = docSnap.data();
      const date = e.createdAt?.toDate
        ? e.createdAt.toDate().toLocaleDateString()
        : "";

      const div = document.createElement("div");
      div.innerHTML = `
        <p><strong>${e.exerciseTitle || "Entrada"}</strong></p>
        <small>${date}</small>
        <hr>
      `;
      container.appendChild(div);
    });
  }

  /* ======================
     EJERCICIOS
  ====================== */
  async function loadExercises() {
    const container = document.getElementById("exercises");

    const snap = await getDocs(
      query(
        collection(db, "exercises"),
        where("active", "==", true),
        orderBy("createdAt", "desc"),
        limit(3)
      )
    );

    if (snap.empty) {
      container.innerHTML = "<p>No hay ejercicios activos ahora mismo.</p>";
      return;
    }

    snap.forEach(docSnap => {
      const ex = docSnap.data();
      const div = document.createElement("div");
      div.innerHTML = `<p>${ex.title}</p>`;
      container.appendChild(div);
    });
  }

  /* ======================
     FORO
  ====================== */
  async function loadForumSuggestions() {
    const container = document.getElementById("forum-suggestions");

    const snap = await getDocs(
      query(
        collection(db, "forumTopics"),
        orderBy("createdAt", "desc"),
        limit(3)
      )
    );

    if (snap.empty) {
      container.innerHTML = "<p>No hay temas todavía.</p>";
      return;
    }

    snap.forEach(docSnap => {
      const t = docSnap.data();
      const div = document.createElement("div");
      div.innerHTML = `<p>${t.title}</p>`;
      container.appendChild(div);
    });
  }

  init();
</script>

</body>
</html>
