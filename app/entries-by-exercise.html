<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Respuestas por ejercicio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">

<nav class="app-menu">
  <a href="index.html">Inicio</a>
  <a href="login.html">Salir</a>
</nav>

<main class="app-container">
  <h1>Respuestas por ejercicio</h1>
  <div id="exercises"></div>
</main>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { db, auth } from "./assets/js/firebase.js";
import {
  collection,
  query,
  orderBy,
  where,
  getDocs,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Auth (terapeuta)
await requireAuth();

// Traer entries
const entriesQuery = query(
  collection(db, "entries"),
  orderBy("createdAt", "desc")
);

const entriesSnap = await getDocs(entriesQuery);
const container = document.getElementById("exercises");

if (entriesSnap.empty) {
  container.innerHTML = "<p>No hay respuestas todavía.</p>";
  throw new Error("Sin datos");
}

// Agrupar por ejercicio
const grouped = {};

entriesSnap.forEach(doc => {
  const entry = doc.data();
  entry.id = doc.id;

  if (!grouped[entry.type]) grouped[entry.type] = [];
  grouped[entry.type].push(entry);
});

// Render
for (const exercise of Object.keys(grouped)) {
  const block = document.createElement("div");
  block.className = "exercise-card";

  block.innerHTML = `<h2>${exercise.replace(/_/g, " ")}</h2>`;

  for (const entry of grouped[exercise]) {
    const entryDiv = document.createElement("div");
    entryDiv.className = "entry-block";

    entryDiv.innerHTML = `
      <hr>
      <p><strong>Paciente:</strong> ${entry.alias || "Paciente"}</p>
      <p><strong>Fecha:</strong> ${entry.createdAt?.toDate().toLocaleString() || ""}</p>
    `;

    // Datos del ejercicio
    for (const key in entry.data) {
      entryDiv.innerHTML += `
        <p><strong>${key.replace(/_/g, " ")}:</strong><br>${entry.data[key]}</p>
      `;
    }

    // Notas del terapeuta (histórico)
    const notesQuery = query(
      collection(db, "therapist_notes"),
      where("entryId", "==", entry.id),
      orderBy("createdAt", "desc")
    );

    const notesSnap = await getDocs(notesQuery);

    const notesDiv = document.createElement("div");
    notesDiv.className = "therapist-notes";

    notesDiv.innerHTML = `<h4>Notas clínicas</h4>`;

    notesSnap.forEach(noteDoc => {
      const note = noteDoc.data();
      notesDiv.innerHTML += `
        <div class="note">
          <p>${note.note}</p>
          <small>${note.createdAt?.toDate().toLocaleString()}</small>
        </div>
      `;
    });

    // Formulario nueva nota
    const form = document.createElement("form");
    form.innerHTML = `
      <textarea placeholder="Añadir nota clínica..." required></textarea>
      <button type="submit">Guardar nota</button>
    `;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = form.querySelector("textarea").value.trim();
      if (!text) return;

      await addDoc(collection(db, "therapist_notes"), {
        entryId: entry.id,
        exercise,
        patientUid: entry.uid,
        therapistUid: auth.currentUser.uid,
        note: text,
        createdAt: serverTimestamp()
      });

      location.reload();
    });

    entryDiv.appendChild(notesDiv);
    entryDiv.appendChild(form);
    block.appendChild(entryDiv);
  }

  container.appendChild(block);
}
</script>

</body>
</html>
