<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ejercicio terap√©utico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/app.css" />
</head>

<body class="app-body">

<nav class="app-menu">
  <a href="exercises-test.html">Volver</a>
  <a href="login.html">Salir</a>
</nav>

<main class="app-container">
  <h1 id="exercise-title"></h1>
  <p id="exercise-description"></p>

  <form id="exercise-form"></form>
</main>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { db, auth } from "./assets/js/firebase.js";
import {
  collection,
  query,
  where,
  getDocs,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// üîê Autenticaci√≥n
await requireAuth();

// 1Ô∏è‚É£ leer slug de la URL
const params = new URLSearchParams(window.location.search);
const slug = params.get("slug");

if (!slug) {
  alert("Ejercicio no especificado");
  throw new Error("Slug ausente");
}

// 2Ô∏è‚É£ buscar ejercicio en Firestore
const q = query(
  collection(db, "exercises"),
  where("slug", "==", slug),
  where("active", "==", true)
);

const snapshot = await getDocs(q);

if (snapshot.empty) {
  alert("Ejercicio no encontrado");
  throw new Error("Ejercicio no existe");
}

const exercise = snapshot.docs[0].data();

// 3Ô∏è‚É£ pintar t√≠tulo y descripci√≥n
document.getElementById("exercise-title").textContent = exercise.title;
document.getElementById("exercise-description").textContent = exercise.description;

// 4Ô∏è‚É£ generar campos din√°micos
const form = document.getElementById("exercise-form");

exercise.fields.forEach(field => {
  const label = document.createElement("label");
  label.textContent = field.replace(/_/g, " ");

  const textarea = document.createElement("textarea");
  textarea.name = field;
  textarea.placeholder = "Escribe aqu√≠‚Ä¶";
  textarea.required = true;

  form.appendChild(label);
  form.appendChild(textarea);
});

// 5Ô∏è‚É£ bot√≥n guardar
const submitBtn = document.createElement("button");
submitBtn.type = "submit";
submitBtn.textContent = "Guardar ejercicio";
form.appendChild(submitBtn);

// 6Ô∏è‚É£ guardar respuestas como ENTRY
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const responses = {};

  exercise.fields.forEach(field => {
    responses[field] = form.querySelector(`[name="${field}"]`).value.trim();
  });

  await addDoc(collection(db, "entries"), {
    uid: auth.currentUser.uid,
    type: "exercise",
    exerciseSlug: slug,
    exerciseTitle: exercise.title,
    responses,
    createdAt: serverTimestamp()
  });

  alert("Ejercicio guardado correctamente");
  form.reset();
});
</script>

</body>
</html>
