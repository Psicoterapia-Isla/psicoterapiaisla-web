<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de pacientes | Psicoterapia Isla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS base -->
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">

<header class="app-menu"></header>

<main class="app-container">

  <h1 class="page-title">Gestión de pacientes</h1>

  <!-- ======================
       CREAR PACIENTE
  ====================== -->
  <section class="card">
    <h2>Nuevo paciente</h2>

    <form id="patient-form">

      <label>
        Nombre completo
        <input
          type="text"
          id="name"
          placeholder="Nombre y apellidos"
          required
        >
      </label>

      <label>
        Email
        <input
          type="email"
          id="email"
          placeholder="email del paciente"
          required
        >
      </label>

      <button type="submit" class="btn-primary">
        Crear paciente
      </button>

    </form>
  </section>

  <!-- ======================
       LISTADO PACIENTES
  ====================== -->
  <section style="margin-top:32px;">
    <h2>Pacientes</h2>
    <div id="patients-list"></div>
  </section>

</main>

<!-- ======================
     SCRIPT
====================== -->
<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { loadMenu } from "./assets/js/menu.js";
  import { db } from "./assets/js/firebase.js";

  import {
    collection,
    addDoc,
    getDocs,
    query,
    where,
    serverTimestamp,
    deleteDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* ======================
     INIT
  ====================== */
  async function init() {
    const user = await requireAuth();
    await loadMenu();

    // solo terapeuta
    const usersSnap = await getDocs(
      query(
        collection(db, "users"),
        where("__name__", "==", user.uid)
      )
    );

    const me = usersSnap.docs[0]?.data();
    if (!me || me.role !== "therapist") {
      alert("Acceso solo para terapeutas");
      window.location.href = "index.html";
      return;
    }

    setupForm(user);
    loadPatients(user.uid);
  }

  /* ======================
     FORMULARIO
  ====================== */
  function setupForm(user) {
    const form = document.getElementById("patient-form");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();

      if (!name || !email) {
        alert("Nombre y email obligatorios");
        return;
      }

      await addDoc(collection(db, "patients"), {
        name,
        email,
        therapistId: user.uid,
        active: true,
        createdAt: serverTimestamp()
      });

      form.reset();
      loadPatients(user.uid);
    });
  }

  /* ======================
     LISTADO
  ====================== */
  async function loadPatients(therapistId) {
    const container = document.getElementById("patients-list");
    container.innerHTML = "";

    const snap = await getDocs(
      query(
        collection(db, "patients"),
        where("therapistId", "==", therapistId)
      )
    );

    if (snap.empty) {
      container.innerHTML = "<p>No hay pacientes creados.</p>";
      return;
    }

    snap.forEach(docSnap => {
      const p = docSnap.data();

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <h3>${p.name}</h3>
        <p>${p.email}</p>
        <p style="opacity:.7">
          Estado: ${p.active ? "Activo" : "Inactivo"}
        </p>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-secondary" data-view>
            Ver respuestas
          </button>

          <button class="btn-secondary" data-delete>
            Eliminar
          </button>
        </div>
      `;

      card.querySelector("[data-view]").addEventListener("click", () => {
        window.location.href =
          `entries-by-patient.html?patientId=${docSnap.id}`;
      });

      card.querySelector("[data-delete]").addEventListener("click", async () => {
        if (!confirm("¿Eliminar paciente?")) return;
        await deleteDoc(doc(db, "patients", docSnap.id));
        loadPatients(therapistId);
      });

      container.appendChild(card);
    });
  }

  init();
</script>

</body>
</html>
