<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de pacientes | Psicoterapia Isla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-layout">

<header class="app-menu"></header>

<main class="app-content">

  <h1 class="page-title">Gestión de pacientes</h1>

  <!-- ======================
       CREAR USUARIO
  ====================== -->
  <section class="card">
    <h2>Nuevo paciente</h2>

    <form id="user-form">
      <input id="nombre" placeholder="Nombre" required>
      <input id="apellidos" placeholder="Apellidos" required>
      <input id="email" type="email" placeholder="Email" required>

      <select id="role">
        <option value="patient">Paciente</option>
        <option value="therapist">Terapeuta</option>
      </select>

      <button class="btn-primary" type="submit">
        Crear usuario (registro manual)
      </button>

      <p style="opacity:.6;font-size:.85rem;margin-top:8px;">
        * El usuario completará su contraseña desde login
      </p>
    </form>
  </section>

  <!-- ======================
       LISTADO
  ====================== -->
  <section class="card">
    <h2>Usuarios registrados</h2>
    <div id="users-list"></div>
  </section>

</main>

<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { loadMenu } from "./assets/js/menu.js";
  import { db } from "./assets/js/firebase.js";

  import {
    collection,
    addDoc,
    getDocs,
    doc,
    getDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  async function init() {
    const user = await requireAuth();
    await loadMenu();

    const snap = await getDoc(doc(db, "users", user.uid));
    if (!snap.exists() || snap.data().role !== "therapist") {
      alert("Acceso restringido");
      window.location.href = "index.html";
      return;
    }

    loadUsers();
    setupForm();
  }

  function setupForm() {
    const form = document.getElementById("user-form");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      await addDoc(collection(db, "users"), {
        nombre: nombre.value.trim(),
        apellidos: apellidos.value.trim(),
        email: email.value.trim(),
        role: role.value,
        createdAt: serverTimestamp()
      });

      form.reset();
      loadUsers();
    });
  }

  async function loadUsers() {
    const container = document.getElementById("users-list");
    container.innerHTML = "";

    const snap = await getDocs(collection(db, "users"));

    snap.forEach(docSnap => {
      const u = docSnap.data();

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <p><strong>${u.nombre || "—"} ${u.apellidos || ""}</strong></p>
        <p>${u.email}</p>
        <p><small>${u.role}</small></p>
        <button class="btn-danger">Eliminar</button>
      `;

      div.querySelector("button").onclick = async () => {
        if (confirm("¿Eliminar usuario?")) {
          await deleteDoc(doc(db, "users", docSnap.id));
          loadUsers();
        }
      };

      container.appendChild(div);
    });
  }

  init();
</script>

</body>
</html>
