<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agenda semanal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="week-wrapper">
  <div id="weekGrid" class="week-grid"></div>
</main>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, getDocs, getDoc, query, where, Timestamp, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();
await loadMenu();

const therapistId = auth.currentUser.uid;
const grid = document.getElementById("weekGrid");

const DAYS=["mon","tue","wed","thu","fri","sat","sun"];
const today=new Date();
const monday=new Date(today);
monday.setDate(today.getDate()-((today.getDay()+6)%7));
monday.setHours(0,0,0,0);

const weekKey=monday.toISOString().slice(0,10);

/* disponibilidad */
const availSnap=await getDoc(doc(db,"availability",`${therapistId}_${weekKey}`));
const avail=availSnap.exists()?availSnap.data().slots||{}:{};

/* citas */
const start=Timestamp.fromDate(monday);
const end=Timestamp.fromDate(new Date(monday.getTime()+7*86400000));
const appsSnap=await getDocs(query(
  collection(db,"appointments"),
  where("therapistId","==",therapistId),
  where("start",">=",start),
  where("start","<",end)
));

const apps={};
appsSnap.forEach(d=>{
  const s=d.data().start.toDate();
  const k=`${DAYS[(s.getDay()+6)%7]}_${s.getHours()}`;
  apps[k]={...d.data(),id:d.id};
});

/* grid */
grid.appendChild(document.createElement("div"));
DAYS.forEach((_,i)=>{
  const d=new Date(monday);
  d.setDate(monday.getDate()+i);
  const h=document.createElement("div");
  h.textContent=d.toLocaleDateString("es-ES",{weekday:"short",day:"numeric"});
  grid.appendChild(h);
});

for(let h=9;h<21;h++){
  const hl=document.createElement("div");
  hl.textContent=`${h}:00`;
  grid.appendChild(hl);

  DAYS.forEach((d,i)=>{
    const k=`${d}_${h}`;
    const cell=document.createElement("div");

    if(apps[k]){
      cell.className="week-slot reserved";
      cell.textContent=apps[k].patientName;
    }
    else if(avail[k]){
      cell.className="week-slot available";
      cell.textContent="Disponible";
      cell.onclick=()=>{
        const date=new Date(monday);
        date.setDate(monday.getDate()+i);
        location.href=`agenda-diaria.html?date=${date.toISOString().slice(0,10)}`;
      };
    }
    else{
      cell.className="week-slot disabled";
    }
    grid.appendChild(cell);
  });
}
</script>
</body>
</html>
