<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agenda semanal | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/app.css">

<style>
.wrapper {
  padding:1.5rem;
  overflow-x:auto;
}

.header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
}

.nav {
  display:flex;
  gap:.5rem;
}

.grid {
  display:grid;
  grid-template-columns:60px repeat(7,minmax(120px,1fr));
  gap:.4rem;
}

.hour {
  font-size:.75rem;
  text-align:right;
  padding-right:6px;
  color:#666;
}

.day {
  text-align:center;
  font-weight:600;
}

.cell {
  height:46px;
  border-radius:10px;
  font-size:.7rem;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}

.free {
  background:#e6f4d7;
  cursor:pointer;
}

.busy {
  background:#fff2cc;
  cursor:pointer;
}

.done {
  background:#e6f0ff;
  cursor:pointer;
}

.off {
  background:#e5e7eb;
}
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="wrapper">

  <div class="header">
    <h1>Agenda semanal</h1>
    <div class="nav">
      <button id="prev" class="btn-secondary">←</button>
      <button id="today" class="btn-secondary">Hoy</button>
      <button id="next" class="btn-secondary">→</button>
    </div>
  </div>

  <div id="grid" class="grid"></div>
</main>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
await requireAuth();
await loadMenu();
</script>

<script type="module">
import { auth, db } from "./assets/js/firebase.js";
import {
  doc, getDoc,
  collection, getDocs, query, where, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const therapistId = auth.currentUser.uid;
const grid = document.getElementById("grid");

const DAYS = ["mon","tue","wed","thu","fri","sat","sun"];
const START = 9;
const END = 21;

/* ===== SEMANA ===== */
function mondayOf(d){
  const x=new Date(d);
  const n=(x.getDay()+6)%7;
  x.setDate(x.getDate()-n);
  x.setHours(0,0,0,0);
  return x;
}

const params=new URLSearchParams(location.search);
const base=params.get("week")?new Date(params.get("week")):new Date();
const monday=mondayOf(base);
const weekKey=monday.toISOString().slice(0,10);

prev.onclick=()=>{
  const d=new Date(monday);d.setDate(d.getDate()-7);
  location.href=`agenda-semanal.html?week=${d.toISOString().slice(0,10)}`;
};
next.onclick=()=>{
  const d=new Date(monday);d.setDate(d.getDate()+7);
  location.href=`agenda-semanal.html?week=${d.toISOString().slice(0,10)}`;
};
today.onclick=()=>location.href="agenda-semanal.html";

/* ===== DISPONIBILIDAD ===== */
const availSnap = await getDoc(
  doc(db,"availability",`${therapistId}_${weekKey}`)
);
const availability = availSnap.exists()
  ? availSnap.data().slots || {}
  : {};

/* ===== CITAS ===== */
const start = Timestamp.fromDate(monday);
const end   = Timestamp.fromDate(
  new Date(monday.getTime()+7*86400000)
);

const appsSnap = await getDocs(query(
  collection(db,"appointments"),
  where("therapistId","==",therapistId),
  where("start",">=",start),
  where("start","<",end)
));

const apps = {};
appsSnap.forEach(d=>{
  const a=d.data();
  const s=a.start.toDate();
  const key=`${DAYS[(s.getDay()+6)%7]}_${s.getHours()}`;
  apps[key]={...a,id:d.id};
});

/* ===== HEADER GRID ===== */
grid.appendChild(document.createElement("div"));
for(let i=0;i<7;i++){
  const d=new Date(monday);
  d.setDate(d.getDate()+i);
  const h=document.createElement("div");
  h.className="day";
  h.textContent=d.toLocaleDateString("es-ES",{weekday:"short",day:"numeric"});
  grid.appendChild(h);
}

/* ===== GRID ===== */
for(let h=START;h<END;h++){
  const hl=document.createElement("div");
  hl.className="hour";
  hl.textContent=`${h}:00`;
  grid.appendChild(hl);

  for(let d=0;d<7;d++){
    const key=`${DAYS[d]}_${h}`;
    const c=document.createElement("div");

    if(apps[key]){
      const a=apps[key];
      c.className=`cell ${a.status==="completed"?"done":"busy"}`;
      c.textContent=a.patientName||"Cita";
      c.onclick=()=>location.href=
        `agenda-diaria.html?date=${a.start.toDate().toISOString().slice(0,10)}`;
    }
    else if(availability[key]){
      c.className="cell free";
      c.textContent="Disponible";
      c.onclick=()=>{
        const dte=new Date(monday);
        dte.setDate(dte.getDate()+d);
        location.href=
          `agenda-diaria.html?date=${dte.toISOString().slice(0,10)}`;
      };
    }
    else{
      c.className="cell off";
    }

    grid.appendChild(c);
  }
}
</script>
</body>
</html>
