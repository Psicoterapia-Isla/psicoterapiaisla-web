<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agenda semanal | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/app.css">

<style>
.week-wrapper { padding:1rem; }

.week-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
}

.week-nav { display:flex; gap:.4rem; }

.week-grid {
  display:grid;
  grid-template-columns:60px repeat(7,1fr);
  gap:.4rem;
}

.week-hour {
  text-align:right;
  font-size:.75rem;
  padding-right:6px;
  color:#666;
}

.day-header {
  text-align:center;
  font-weight:600;
}

.week-slot {
  height:48px;
  border-radius:12px;
  font-size:.7rem;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.week-slot.available { background:#e6f4d7; }
.week-slot.reserved { background:#fff2cc; }
.week-slot.done { background:#e6f0ff; }
.week-slot.disabled { background:#e5e7eb; cursor:not-allowed; }
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="week-wrapper">
  <div class="week-header">
    <h1>Agenda semanal</h1>
    <div class="week-nav">
      <button id="prevWeek" class="btn-secondary">←</button>
      <button id="todayWeek" class="btn-secondary">Hoy</button>
      <button id="nextWeek" class="btn-secondary">→</button>
    </div>
  </div>

  <div id="weekGrid" class="week-grid"></div>
</main>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";

import {
  collection,getDocs,query,where,Timestamp,doc,getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth(); await loadMenu();

const therapistId=auth.currentUser.uid;
const grid=document.getElementById("weekGrid");
const DAYS=["mon","tue","wed","thu","fri","sat","sun"];

function mondayOf(d){
  const x=new Date(d);
  x.setDate(x.getDate()-((x.getDay()+6)%7));
  x.setHours(0,0,0,0); return x;
}

const p=new URLSearchParams(location.search);
const monday=mondayOf(p.get("week")||new Date());
const weekKey=monday.toISOString().slice(0,10);

prevWeek.onclick=()=>go(-1);
nextWeek.onclick=()=>go(1);
todayWeek.onclick=()=>location.href="agenda-semanal.html";
function go(o){
  const d=new Date(monday); d.setDate(d.getDate()+o*7);
  location.href=`agenda-semanal.html?week=${d.toISOString().slice(0,10)}`;
}

const availSnap=await getDoc(doc(db,"availability",`${therapistId}_${weekKey}`));
const availability=availSnap.exists()?availSnap.data().slots||{}:{};

const start=Timestamp.fromDate(monday);
const end=Timestamp.fromDate(new Date(monday.getTime()+7*86400000));

const appSnap=await getDocs(query(
  collection(db,"appointments"),
  where("therapistId","==",therapistId),
  where("start",">=",start),
  where("start","<",end)
));

const apps={};
appSnap.forEach(d=>{
  const a=d.data(), s=a.start.toDate();
  apps[`${DAYS[(s.getDay()+6)%7]}_${s.getHours()}`]={...a,id:d.id};
});

grid.appendChild(document.createElement("div"));
for(let i=0;i<7;i++){
  const d=new Date(monday); d.setDate(monday.getDate()+i);
  const h=document.createElement("div");
  h.className="day-header";
  h.textContent=d.toLocaleDateString("es-ES",{weekday:"short",day:"numeric"});
  grid.appendChild(h);
}

for(let h=9;h<21;h++){
  const hc=document.createElement("div");
  hc.className="week-hour";
  hc.textContent=`${h}:00`;
  grid.appendChild(hc);

  for(let d=0;d<7;d++){
    const key=`${DAYS[d]}_${h}`;
    const c=document.createElement("div");

    if(apps[key]){
      const a=apps[key];
      c.className=`week-slot ${a.status==="completed"?"done":"reserved"}`;
      c.textContent=a.patientName;
      c.onclick=()=>location.href=`agenda-diaria.html?date=${toISO(a.start.toDate())}`;
    }
    else if(availability[key]){
      c.className="week-slot available";
      c.textContent="Disponible";
      c.onclick=()=>location.href=`agenda-diaria.html?date=${toISO(new Date(monday.getTime()+d*86400000))}`;
    }
    else{
      c.className="week-slot disabled";
    }
    grid.appendChild(c);
  }
}

function toISO(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
</script>
</body>
</html>
