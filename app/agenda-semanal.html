<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agenda semanal | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/app.css">

<style>
.week-wrapper { max-width:600px; margin:0 auto; padding:1rem; }

.week-header {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:1rem;
}

.week-nav { display:flex; gap:.5rem; }

.week-day { margin-bottom:1.5rem; }

.week-day h3 { margin:.5rem 0; }

.week-card {
  background:#e6f4d7;
  border-radius:14px;
  padding:.75rem 1rem;
  display:flex;
  justify-content:space-between;
  margin-bottom:.5rem;
}

.week-card.done { opacity:.7; }

.week-left { display:flex; gap:.75rem; }

.week-hour { font-weight:600; }
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="week-wrapper">

  <div class="week-header">
    <h1>Agenda semanal</h1>
    <div class="week-nav">
      <button id="prevWeek" class="btn-secondary">←</button>
      <button id="todayWeek" class="btn-secondary">Hoy</button>
      <button id="nextWeek" class="btn-secondary">→</button>
    </div>
  </div>

  <div id="weekGrid"></div>
</main>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, getDocs, query, where, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();
await loadMenu();

const therapistId=auth.currentUser.uid;
const grid=document.getElementById("weekGrid");

function mondayOf(date){
  const d=new Date(date);
  const day=(d.getDay()+6)%7;
  d.setDate(d.getDate()-day);
  d.setHours(0,0,0,0);
  return d;
}

const params=new URLSearchParams(location.search);
const baseDate=params.get("week")?new Date(params.get("week")):new Date();
const monday=mondayOf(baseDate);

function go(w){
  const d=new Date(monday); d.setDate(d.getDate()+w*7);
  location.href=`agenda-semanal.html?week=${d.toISOString().slice(0,10)}`;
}

prevWeek.onclick=()=>go(-1);
nextWeek.onclick=()=>go(1);
todayWeek.onclick=()=>location.href="agenda-semanal.html";

const start=Timestamp.fromDate(monday);
const end=Timestamp.fromDate(new Date(monday.getTime()+7*86400000));

const snap=await getDocs(query(
  collection(db,"appointments"),
  where("therapistId","==",therapistId),
  where("start",">=",start),
  where("start","<",end)
));

const byDay={};
snap.forEach(d=>{
  const a={...d.data(),id:d.id};
  const s=a.start.toDate();
  const key=s.toISOString().slice(0,10);
  (byDay[key]??=[]).push(a);
});

Object.keys(byDay).sort().forEach(date=>{
  const day=new Date(date);
  const block=document.createElement("div");
  block.className="week-day";
  block.innerHTML=`<h3>${day.toLocaleDateString("es-ES",{weekday:"long",day:"numeric"})}</h3>`;

  byDay[date].sort((a,b)=>a.start.seconds-b.start.seconds).forEach(app=>{
    const h=app.start.toDate().getHours();
    const card=document.createElement("div");
    card.className=`week-card ${app.status==="completed"?"done":""}`;
    card.innerHTML=`
      <div class="week-left">
        <div class="week-hour">${h}:00</div>
        <div>
          <strong>${app.patientName}</strong><br>
          <small>${app.service||"Visita Psicología"}</small>
        </div>
      </div>
      <div>${app.status==="completed"?"✔️":""}</div>
    `;
    card.onclick=()=>location.href=`agenda-diaria.html?date=${date}`;
    block.appendChild(card);
  });

  grid.appendChild(block);
});
</script>
</body>
</html>
