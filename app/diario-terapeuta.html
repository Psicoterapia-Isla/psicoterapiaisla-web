<body class="app-body app-diarios">

<header class="app-menu"></header>

<main class="app-container">
  <h1 class="page-title">Diarios terap√©uticos</h1>

  <div class="card">
    <div id="entries"></div>
  </div>
</main>

<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { loadMenu } from "./assets/js/menu.js";
  import { db } from "./assets/js/firebase.js";
  import {
    collection,
    query,
    orderBy,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  await requireAuth();
  await loadMenu();

  const exercisesSnap = await getDocs(collection(db, "exercises"));
  const exerciseTitles = {};

  exercisesSnap.forEach(doc => {
    const d = doc.data();
    if (d.slug && d.title) {
      exerciseTitles[d.slug] = d.title;
    }
  });

  const q = query(
    collection(db, "entries"),
    orderBy("createdAt", "desc")
  );

  const snap = await getDocs(q);
  const container = document.getElementById("entries");

  snap.forEach(doc => {
    const entry = doc.data();
    const card = document.createElement("div");
    card.className = "entry-card";

    if (entry.type) {
      const title = document.createElement("h3");
      title.textContent = exerciseTitles[entry.type] || entry.type;
      card.appendChild(title);

      const date = document.createElement("small");
      date.textContent = entry.createdAt?.toDate
        ? entry.createdAt.toDate().toLocaleString()
        : "";
      card.appendChild(date);

      const data = entry.data || {};
      Object.entries(data).forEach(([key, value]) => {
        const fieldTitle = document.createElement("h4");
        fieldTitle.textContent = key.replace(/_/g, " ");

        const fieldValue = document.createElement("p");
        fieldValue.textContent = value;

        card.appendChild(fieldTitle);
        card.appendChild(fieldValue);
      });
    } else {
      const text = document.createElement("p");
      text.textContent = entry.text || "(sin contenido)";
      card.appendChild(text);
    }

    container.appendChild(card);
  });
</script>

</body>
