<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="assets/css/app.css">

<style>
.wrapper { max-width:1100px; margin:0 auto; padding:1.5rem; }
.header { display:flex; justify-content:space-between; align-items:center; gap:1rem; }
.nav { display:flex; gap:.5rem; }
.hours { margin-top:1.5rem; }
.slot {
  display:flex;
  align-items:center;
  gap:1rem;
  padding:.75rem;
  border-bottom:1px solid #e5e7eb;
  cursor:pointer;
}
.slot.free { color:#777; }
.slot.busy { background:#eef6f1; border-radius:8px; }
.modal {
  position:fixed; inset:0;
  background:rgba(0,0,0,.4);
  display:none; align-items:center; justify-content:center;
}
.modal-content {
  background:#fff;
  padding:1.5rem;
  border-radius:12px;
  width:100%; max-width:420px;
}
.modal-content h3 { margin-top:0; }
input, select {
  width:100%;
  padding:.5rem;
  margin-bottom:.5rem;
}
.actions { display:flex; gap:.5rem; justify-content:flex-end; }
.suggestions {
  background:#fff;
  border:1px solid #ddd;
  border-radius:6px;
  max-height:150px;
  overflow:auto;
}
.suggestions div {
  padding:.4rem;
  cursor:pointer;
}
.suggestions div:hover { background:#f0f0f0; }
</style>
</head>

<body class="app-body">

<header class="app-menu"></header>

<main class="wrapper">

  <div class="header">
    <h1>Agenda</h1>
    <div class="nav">
      <button id="prev">←</button>
      <button id="today">Hoy</button>
      <button id="next">→</button>
      <button id="new">+ Cita</button>
    </div>
  </div>

  <div id="dateLabel"></div>

  <div id="hours" class="hours"></div>

</main>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Cita</h3>

    <label>Teléfono</label>
    <input id="phone">
    <div id="phoneResults" class="suggestions"></div>

    <label>Nombre</label>
    <input id="name">
    <div id="nameResults" class="suggestions"></div>

    <label>Servicio</label>
    <input id="service" value="Visita Psicología">

    <label>Modalidad</label>
    <select id="modality">
      <option value="viladecans">Viladecans</option>
      <option value="badalona">Badalona</option>
      <option value="online">Online</option>
    </select>

    <label>Inicio</label>
    <input type="time" id="start">

    <label>Fin</label>
    <input type="time" id="end">

    <label>
      <input type="checkbox" id="done"> Sesión realizada
    </label>

    <label>Importe (€)</label>
    <input type="number" id="amount">

    <div class="actions">
      <button id="invoice">Generar factura</button>
      <button id="save">Guardar</button>
      <button id="close">Cerrar</button>
    </div>
  </div>
</div>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";

import {
  collection, query, where, getDocs,
  addDoc, updateDoc, doc, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();
await loadMenu();

const hoursEl = document.getElementById("hours");
const dateLabel = document.getElementById("dateLabel");
const modal = document.getElementById("modal");

let currentDate = new Date();
let currentAppointment = null;

function iso(d){ return d.toISOString().slice(0,10); }

function renderDate(){
  dateLabel.textContent = currentDate.toLocaleDateString("es-ES",{
    weekday:"long", day:"numeric", month:"long", year:"numeric"
  });
}

async function load(){
  hoursEl.innerHTML = "";
  renderDate();

  const base = new Date(currentDate);
  base.setHours(0,0,0,0);

  const snap = await getDocs(query(
    collection(db,"appointments"),
    where("therapistId","==",auth.currentUser.uid),
    where("start",">=",Timestamp.fromDate(base)),
    where("start","<",Timestamp.fromDate(new Date(base.getTime()+86400000)))
  ));

  const byHour = {};
  snap.forEach(d=>{
    byHour[d.data().start.toDate().getHours()] = { ...d.data(), id:d.id };
  });

  for(let h=9;h<=20;h++){
    const div=document.createElement("div");
    if(byHour[h]){
      div.className="slot busy";
      div.textContent = `${h}:00 · ${byHour[h].patientName}`;
      div.onclick=()=>openModal(byHour[h]);
    } else {
      div.className="slot free";
      div.textContent = `${h}:00 · Libre`;
      div.onclick=()=>openModal({ hour:h });
    }
    hoursEl.appendChild(div);
  }
}

function openModal(a){
  currentAppointment = a.id ? a : null;
  modal.style.display="flex";

  phone.value = a.patientId || "";
  name.value = a.patientName || "";
  service.value = a.service || "Visita Psicología";
  modality.value = a.modality || "viladecans";
  start.value = a.start ? a.start.toDate().toISOString().slice(11,16) : `${a.hour}:00`;
  end.value = a.end ? a.end.toDate().toISOString().slice(11,16) : `${a.hour+1}:00`;
  done.checked = a.status === "completed";
  amount.value = a.amount || "";
}

close.onclick=()=>modal.style.display="none";

save.onclick=async()=>{
  const base = new Date(currentDate);
  base.setHours(0,0,0,0);
  const [sh,sm]=start.value.split(":");
  const [eh,em]=end.value.split(":");

  const s=new Date(base); s.setHours(sh,sm);
  const e=new Date(base); e.setHours(eh,em);

  const data={
    therapistId:auth.currentUser.uid,
    patientId:phone.value,
    patientName:name.value,
    service:service.value,
    modality:modality.value,
    start:Timestamp.fromDate(s),
    end:Timestamp.fromDate(e),
    status:done.checked?"completed":"scheduled",
    amount:+amount.value||null
  };

  if(currentAppointment){
    await updateDoc(doc(db,"appointments",currentAppointment.id),data);
  } else {
    await addDoc(collection(db,"appointments"),{
      ...data,
      createdAt:Timestamp.now()
    });
  }

  modal.style.display="none";
  load();
};

/* FACTURA */
invoice.onclick=async()=>{
  if(!currentAppointment) return alert("Guarda la cita primero");

  await fetch("/emit-invoice",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ appointmentId: currentAppointment.id })
  });

  alert("Factura emitida y enviada por WhatsApp");
};

prev.onclick=()=>{ currentDate.setDate(currentDate.getDate()-1); load(); };
next.onclick=()=>{ currentDate.setDate(currentDate.getDate()+1); load(); };
today.onclick=()=>{ currentDate=new Date(); load(); };
new.onclick=()=>openModal({ hour:9 });

load();
</script>

</body>
</html>
