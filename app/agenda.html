<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/css/app.css">

<style>
.wrapper{max-width:1200px;margin:0 auto;padding:1.5rem}
.header{display:flex;justify-content:space-between;align-items:center}
.hours{display:grid;grid-template-columns:80px 1fr;gap:.4rem;margin-top:1rem}
.hour-label{font-weight:600}
.slot{padding:.6rem;border-radius:10px;background:#e5e7eb;cursor:pointer}
.slot.busy{background:#d1fae5}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999}
.modal-card{background:#fff;max-width:460px;margin:8vh auto;padding:1rem;border-radius:16px}
input,select{width:100%;margin-bottom:.5rem;padding:.45rem}
.results{background:#f3f4f6;border-radius:8px;max-height:120px;overflow:auto}
.results div{padding:.35rem;cursor:pointer}
.results div:hover{background:#e5e7eb}
.actions{display:flex;justify-content:space-between;margin-top:.5rem}
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="wrapper">
  <div class="header">
    <h1>Agenda</h1>
    <div>
      <button id="prev">←</button>
      <button id="today">Hoy</button>
      <button id="next">→</button>
      <button id="new">+ Cita</button>
    </div>
  </div>

  <div id="dateLabel"></div>
  <div id="hours" class="hours"></div>
</main>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-card">
    <h3>Cita</h3>

    <input id="phone" placeholder="Teléfono">
    <div id="results" class="results"></div>

    <input id="name" placeholder="Nombre completo">
    <input id="service" value="Visita Psicología">

    <select id="modality">
      <option value="">Modalidad</option>
      <option value="viladecans">Viladecans</option>
      <option value="badalona">Badalona</option>
      <option value="online">Online</option>
    </select>

    <input id="start" type="time">
    <input id="end" type="time">

    <label><input type="checkbox" id="done"> Sesión realizada</label>
    <input id="amount" placeholder="Importe (€)">
    <label><input type="checkbox" id="paid"> Pagada</label>

    <div class="actions">
      <button id="save">Guardar</button>
      <button onclick="closeModal()">Cerrar</button>
    </div>
  </div>
</div>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, query, where, getDocs,
  addDoc, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();
await loadMenu();

let currentDate=new Date();
const hoursDiv=document.getElementById("hours");
const dateLabel=document.getElementById("dateLabel");

/* ===== RENDER ===== */
function render(){
  hoursDiv.innerHTML="";
  dateLabel.textContent=currentDate.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
  for(let h=9;h<21;h++){
    const l=document.createElement("div");
    l.className="hour-label";
    l.textContent=`${h}:00`;
    const s=document.createElement("div");
    s.className="slot";
    s.textContent="Libre";
    s.onclick=()=>openNew(h);
    hoursDiv.append(l,s);
  }
}
render();

/* ===== NAV ===== */
prev.onclick=()=>{currentDate.setDate(currentDate.getDate()-1);render();};
next.onclick=()=>{currentDate.setDate(currentDate.getDate()+1);render();};
today.onclick=()=>{currentDate=new Date();render();};
new.onclick=()=>openNew(9);

/* ===== MODAL ===== */
function resetModal(){
  phone.value="";
  name.value="";
  amount.value="";
  done.checked=false;
  paid.checked=false;
  results.innerHTML="";
}
window.openNew=(h)=>{
  resetModal();
  start.value=`${String(h).padStart(2,"0")}:00`;
  end.value=`${String(h+1).padStart(2,"0")}:00`;
  modal.style.display="block";
};
window.closeModal=()=>modal.style.display="none";

/* ===== AUTOCOMPLETE EN TIEMPO REAL ===== */
phone.oninput=async()=>{
  results.innerHTML="";
  const v=phone.value.toLowerCase();
  if(v.length<2) return;

  const q=query(
    collection(db,"patients_normalized"),
    where("search","array-contains",v)
  );
  const snap=await getDocs(q);

  snap.forEach(d=>{
    const p=d.data();
    const r=document.createElement("div");
    r.textContent=`${p.fullName} · ${p.phone}`;
    r.onclick=()=>{
      phone.value=p.phone;
      name.value=p.fullName;
      results.innerHTML="";
    };
    results.appendChild(r);
  });
};

/* ===== SAVE ===== */
save.onclick=async()=>{
  const user=auth.currentUser;
  const base=new Date(currentDate);
  const [sh,sm]=start.value.split(":");
  const [eh,em]=end.value.split(":");
  const s=new Date(base);s.setHours(sh,sm);
  const e=new Date(base);e.setHours(eh,em);

  await addDoc(collection(db,"appointments"),{
    therapistId:user.uid,
    patientId:phone.value,
    patientName:name.value,
    service:service.value,
    modality:modality.value,
    start:Timestamp.fromDate(s),
    end:Timestamp.fromDate(e),
    status:done.checked?"completed":"scheduled",
    paid:paid.checked,
    amount:Number(amount.value||0),
    createdAt:Timestamp.now()
  });

  window.open(`https://wa.me/34${phone.value}?text=Tu cita ha sido confirmada`, "_blank");
  closeModal();
  render();
};
</script>
</body>
</html>
