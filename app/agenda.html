<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/css/app.css">

<style>
body { background:#f7f6f3; }
.wrapper { max-width:1100px; margin:0 auto; padding:1.5rem; }
.header { display:flex; align-items:center; gap:1rem; }
.header h1 { flex:1; }
.grid { display:grid; grid-template-columns:80px 1fr; gap:.5rem; margin-top:1rem; }
.hour { color:#666; font-weight:600; }
.slot { background:#fff; border-radius:10px; padding:.5rem; cursor:pointer; }
.slot.busy { background:#e6f4d7; }
.slot.done { background:#dbeafe; }
.slot.paid { background:#dcfce7; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; }
.modal-card {
  background:#fff;
  max-width:420px;
  margin:8vh auto;
  padding:1rem;
  border-radius:14px;
}
.modal-card label { font-size:.8rem; display:block; margin-top:.5rem; }
.modal-card input, select { width:100%; padding:.4rem; }
.actions { margin-top:1rem; display:flex; gap:.5rem; justify-content:flex-end; }
.autocomplete {
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  z-index:10;
}
.autocomplete div { padding:.4rem; cursor:pointer; }
.autocomplete div:hover { background:#eee; }
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="wrapper">
  <div class="header">
    <h1>Agenda</h1>
    <button id="prev">‚Üê</button>
    <button id="today">Hoy</button>
    <button id="next">‚Üí</button>
    <button id="new">+ Cita</button>
  </div>

  <div id="dateLabel"></div>
  <div id="grid" class="grid"></div>
</main>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-card">
    <h3>Cita</h3>

    <label>Tel√©fono</label>
    <input id="phone">
    <div id="acPhone" class="autocomplete"></div>

    <label>Nombre</label>
    <input id="name">
    <div id="acName" class="autocomplete"></div>

    <label>Servicio</label>
    <input id="service" value="Visita Psicolog√≠a">

    <label>Modalidad</label>
    <select id="modality">
      <option value="viladecans">Viladecans</option>
      <option value="badalona">Badalona</option>
      <option value="online">Online</option>
    </select>

    <label>Inicio</label>
    <input type="time" id="start">

    <label>Fin</label>
    <input type="time" id="end">

    <label><input type="checkbox" id="done"> Sesi√≥n realizada</label>
    <label><input type="checkbox" id="paid"> Pagada</label>

    <label>Importe (‚Ç¨)</label>
    <input type="number" id="amount" value="70">

    <div class="actions">
      <button id="wa">WhatsApp</button>
      <button id="pdf">Factura PDF</button>
      <button id="save">Guardar</button>
      <button id="close">Cerrar</button>
    </div>
  </div>
</div>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, query, where, getDocs,
  addDoc, updateDoc, doc, Timestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();
await loadMenu();

/* =======================
   ESTADO
======================= */
let currentDate = new Date();
let editing = null;

const grid = document.getElementById("grid");
const dateLabel = document.getElementById("dateLabel");
const modal = document.getElementById("modal");

/* =======================
   FECHA
======================= */
function renderDate(){
  dateLabel.textContent =
    currentDate.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
}

/* =======================
   CARGA AGENDA
======================= */
async function load(){
  renderDate();
  grid.innerHTML="";
  const startDay = new Date(currentDate); startDay.setHours(0,0,0,0);
  const endDay = new Date(startDay.getTime()+86400000);

  const snap = await getDocs(query(
    collection(db,"appointments"),
    where("therapistId","==",auth.currentUser.uid),
    where("start",">=",Timestamp.fromDate(startDay)),
    where("start","<",Timestamp.fromDate(endDay))
  ));

  const byHour = {};
  snap.forEach(d=>{
    byHour[d.data().start.toDate().getHours()] = { id:d.id, ...d.data() };
  });

  for(let h=9;h<21;h++){
    grid.appendChild(Object.assign(document.createElement("div"),{
      className:"hour", textContent:`${h}:00`
    }));

    const cell = document.createElement("div");
    cell.className="slot";

    if(byHour[h]){
      const a = byHour[h];
      cell.textContent = a.patientName;
      cell.classList.add(a.invoiceId?"paid":a.status==="completed"?"done":"busy");
      cell.addEventListener("click",()=>openModal(a));
    } else {
      cell.textContent="Libre";
      cell.addEventListener("click",()=>openModal(null,h));
    }
    grid.appendChild(cell);
  }
}

/* =======================
   MODAL
======================= */
function openModal(a,h){
  editing=a;
  modal.style.display="block";
  phone.value=a?.patientId||"";
  name.value=a?.patientName||"";
  start.value=a?a.start.toDate().toTimeString().slice(0,5):`${h||9}:00`;
  end.value=a?a.end.toDate().toTimeString().slice(0,5):`${(h||9)+1}:00`;
  done.checked=a?.status==="completed";
  paid.checked=!!a?.invoiceId;
}
function closeModal(){ modal.style.display="none"; }

/* =======================
   EVENTOS
======================= */
prev.addEventListener("click",()=>{ currentDate.setDate(currentDate.getDate()-1); load(); });
next.addEventListener("click",()=>{ currentDate.setDate(currentDate.getDate()+1); load(); });
today.addEventListener("click",()=>{ currentDate=new Date(); load(); });
new.addEventListener("click",()=>openModal());
close.addEventListener("click",closeModal);

/* =======================
   GUARDAR
======================= */
save.addEventListener("click",async()=>{
  const base=new Date(currentDate); base.setHours(0,0,0,0);
  const [sh,sm]=start.value.split(":");
  const [eh,em]=end.value.split(":");

  const s=new Date(base); s.setHours(sh,sm);
  const e=new Date(base); e.setHours(eh,em);

  const data={
    therapistId:auth.currentUser.uid,
    patientId:phone.value,
    patientName:name.value,
    service:service.value,
    modality:modality.value,
    start:Timestamp.fromDate(s),
    end:Timestamp.fromDate(e),
    status:done.checked?"completed":"scheduled",
    completedAt:done.checked?Timestamp.now():null
  };

  if(editing){
    await updateDoc(doc(db,"appointments",editing.id),data);
  } else {
    await addDoc(collection(db,"appointments"),data);
  }
  closeModal(); load();
});

/* =======================
   WHATSAPP
======================= */
wa.addEventListener("click",()=>{
  const msg=encodeURIComponent(
    `Hola ${name.value} üòä\nTu cita:\nüìÖ ${dateLabel.textContent}\nüïò ${start.value}-${end.value}`
  );
  window.open(`https://wa.me/34${phone.value}?text=${msg}`);
});

/* =======================
   PDF SIMPLE
======================= */
pdf.addEventListener("click",()=>{
  const w=window.open("");
  w.document.write(`<h1>Factura</h1><p>${name.value}</p><p>${amount.value} ‚Ç¨</p>`);
});

load();
</script>
</body>
</html>
