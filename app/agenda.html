<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Agenda | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/css/app.css">

<style>
.wrapper { max-width:1100px; margin:0 auto; padding:1.5rem; }
.header { display:flex; align-items:center; gap:.5rem; }
.header h1 { flex:1; }
.hours { display:grid; grid-template-columns:80px 1fr; gap:.5rem; margin-top:1rem; }
.hour { font-weight:600; color:#555; }
.slot { background:#f3f4f6; border-radius:10px; padding:.5rem; cursor:pointer; }
.slot.busy { background:#d1fae5; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; }
.modal-card { background:#fff; max-width:420px; margin:10vh auto; padding:1rem; border-radius:14px; }
.suggestions { background:#fff; border:1px solid #ddd; max-height:120px; overflow:auto; }
.suggestions div { padding:.4rem; cursor:pointer; }
.suggestions div:hover { background:#e5e7eb; }
.actions { display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem; }
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="wrapper">
  <div class="header">
    <h1>Agenda</h1>
    <button id="prev">←</button>
    <button id="today">Hoy</button>
    <button id="next">→</button>
    <button id="new">+ Cita</button>
  </div>

  <div id="dateLabel"></div>
  <div id="list" class="hours"></div>
</main>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-card">
    <h3>Cita</h3>

    <label>Teléfono</label>
    <input id="phone">
    <div id="phoneSug" class="suggestions"></div>

    <label>Nombre</label>
    <input id="name">
    <div id="nameSug" class="suggestions"></div>

    <label>Servicio</label>
    <input id="service" value="Visita Psicología">

    <label>Modalidad</label>
    <select id="modality">
      <option value="viladecans">Viladecans</option>
      <option value="badalona">Badalona</option>
      <option value="online">Online</option>
    </select>

    <label>Inicio</label>
    <input type="time" id="start">

    <label>Fin</label>
    <input type="time" id="end">

    <label><input type="checkbox" id="done"> Sesión realizada</label>
    <label>Importe (€)</label>
    <input id="amount" value="70">

    <label><input type="checkbox" id="paid"> Pagada</label>

    <div class="actions">
      <button id="save">Guardar</button>
      <button id="close">Cerrar</button>
    </div>
  </div>
</div>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, query, where, getDocs, addDoc, updateDoc,
  Timestamp, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();
await loadMenu();

/* ===== DATE ===== */
let current = new Date();
current.setHours(0,0,0,0);

const list = document.getElementById("list");
const label = document.getElementById("dateLabel");

/* ===== NAV ===== */
prev.onclick = ()=>move(-1);
next.onclick = ()=>move(1);
today.onclick = ()=>{ current=new Date(); render(); };

function move(n){
  current.setDate(current.getDate()+n);
  render();
}

/* ===== LOAD ===== */
async function render(){
  label.textContent = current.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"});
  list.innerHTML="";

  const start = Timestamp.fromDate(current);
  const end = Timestamp.fromDate(new Date(current.getTime()+86400000));

  const snap = await getDocs(query(
    collection(db,"appointments"),
    where("therapistId","==",auth.currentUser.uid),
    where("start",">=",start),
    where("start","<",end)
  ));

  const byHour = {};
  snap.forEach(d=>{
    byHour[d.data().start.toDate().getHours()]={...d.data(),id:d.id};
  });

  for(let h=9;h<21;h++){
    list.insertAdjacentHTML("beforeend",`
      <div class="hour">${h}:00</div>
      <div class="slot ${byHour[h]?"busy":""}" data-hour="${h}">
        ${byHour[h]?byHour[h].patientName:"Libre"}
      </div>
    `);
  }

  document.querySelectorAll(".slot").forEach(s=>{
    s.addEventListener("click",()=>openModal(byHour[s.dataset.hour],s.dataset.hour));
  });
}

/* ===== MODAL ===== */
let editing=null;

function reset(){
  editing=null;
  phone.value=name.value="";
  start.value=end.value="";
  done.checked=paid.checked=false;
}

function openModal(app,h){
  reset();
  modal.style.display="block";
  start.value=`${h}:00`;
  end.value=`${Number(h)+1}:00`;

  if(app){
    editing=app;
    phone.value=app.patientId;
    name.value=app.patientName;
    start.value=app.start.toDate().toTimeString().slice(0,5);
    end.value=app.end.toDate().toTimeString().slice(0,5);
    done.checked=app.status==="completed";
  }
}

close.onclick=()=>modal.style.display="none";

/* ===== AUTOCOMPLETE PROGRESIVO ===== */
async function searchPatients(field,val,box){
  box.innerHTML="";
  if(val.length<2) return;

  const snap = await getDocs(query(
    collection(db,"patients_normalized"),
    where(field,">=",val),
    where(field,"<",val+"\uf8ff")
  ));

  snap.forEach(d=>{
    const r=d.data();
    const div=document.createElement("div");
    div.textContent=`${r.fullName} (${r.phone})`;
    div.onclick=()=>{
      phone.value=r.phone;
      name.value=r.fullName;
      box.innerHTML="";
    };
    box.appendChild(div);
  });
}

phone.addEventListener("input",e=>searchPatients("phone",e.target.value,phoneSug));
name.addEventListener("input",e=>searchPatients("name",e.target.value.toLowerCase(),nameSug));

/* ===== SAVE ===== */
save.onclick=async()=>{
  const base=new Date(current);
  const [sh]=start.value.split(":");
  const [eh]=end.value.split(":");

  const s=new Date(base); s.setHours(sh,0,0,0);
  const e=new Date(base); e.setHours(eh,0,0,0);

  const data={
    therapistId:auth.currentUser.uid,
    patientId:phone.value,
    patientName:name.value,
    service:service.value,
    modality:modality.value,
    start:Timestamp.fromDate(s),
    end:Timestamp.fromDate(e),
    status:done.checked?"completed":"scheduled",
    paid:paid.checked
  };

  if(editing){
    await updateDoc(doc(db,"appointments",editing.id),data);
  } else {
    await addDoc(collection(db,"appointments"),data);
  }

  modal.style.display="none";
  render();
};

/* INIT */
render();
</script>
</body>
</html>
