<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agenda | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/app.css">

<style>
.wrapper{max-width:1100px;margin:0 auto;padding:1.5rem}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
.nav{display:flex;gap:.5rem}
.day-info{margin-bottom:1rem;color:#555}

.slot{
  display:flex;gap:1rem;align-items:center;
  padding:.75rem;border-radius:12px;margin-bottom:.5rem;
  cursor:pointer
}
.slot.free{background:#e5e7eb}
.slot.busy{background:#e6f4d7}
.slot.done{background:#e6f0ff}

.time{width:60px;font-weight:600}
.meta{flex:1}
.badges{display:flex;gap:.4rem;flex-wrap:wrap}
.badge{
  font-size:.65rem;padding:.2rem .45rem;
  border-radius:6px;background:#ddd
}
.badge.done{background:#bfdbfe}
.badge.paid{background:#bbf7d0}
.badge.invoice{background:#fde68a}

.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.4);z-index:999
}
.modal-card{
  background:#fff;max-width:460px;
  margin:8vh auto;padding:1rem;border-radius:16px
}
.row{margin-bottom:.75rem}
.row.inline{display:flex;gap:.5rem;align-items:center}
.modal-actions{
  display:flex;justify-content:flex-end;gap:.5rem
}
hr{border:none;border-top:1px solid #eee;margin:.75rem 0}
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="wrapper">

  <div class="header">
    <h1>Agenda</h1>
    <div class="nav">
      <button id="prev" class="btn-secondary">←</button>
      <button id="today" class="btn-secondary">Hoy</button>
      <button id="next" class="btn-secondary">→</button>
      <button id="new" class="btn-primary">＋ Cita</button>
    </div>
  </div>

  <div class="day-info" id="dayInfo"></div>
  <div id="list"></div>
</main>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modal-card">

    <h3 id="mTitle"></h3>

    <div class="row">
      <label>Teléfono</label>
      <input id="mPhone" type="text" maxlength="9">
    </div>

    <div class="row">
      <label>Nombre</label>
      <input id="mName" type="text">
    </div>

    <div class="row">
      <label>Modalidad</label>
      <select id="mModality">
        <option value="">—</option>
        <option value="viladecans">Viladecans</option>
        <option value="badalona">Badalona</option>
        <option value="online">Online</option>
      </select>
    </div>

    <div class="row inline">
      <input type="checkbox" id="mDone">
      <label>Sesión realizada</label>
    </div>

    <hr>

    <div class="row">
      <label>Importe (€)</label>
      <input id="mAmount" type="number" value="60" min="0">
    </div>

    <div class="row">
      <label>Método de pago</label>
      <select id="mPayment">
        <option value="">—</option>
        <option value="efectivo">Efectivo</option>
        <option value="tarjeta">Tarjeta</option>
        <option value="bizum">Bizum</option>
        <option value="transferencia">Transferencia</option>
      </select>
    </div>

    <div class="row inline">
      <input type="checkbox" id="mPaid">
      <label>Pagada</label>
    </div>

    <div class="row inline">
      <input type="checkbox" id="mInvoiced" disabled>
      <label>Factura emitida</label>
    </div>

    <div class="modal-actions">
      <button id="invoice" class="btn-primary">Emitir factura</button>
      <button id="save" class="btn-primary">Guardar</button>
      <button onclick="closeModal()">Cerrar</button>
    </div>

  </div>
</div>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
await requireAuth();
await loadMenu();
</script>

<script type="module">
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, query, where, orderBy,
  getDocs, addDoc, updateDoc, doc,
  Timestamp, serverTimestamp, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* =========================
   FECHA
========================= */
let currentDate =
  new URLSearchParams(location.search).get("date")
  || new Date().toISOString().split("T")[0];

function toISO(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

prev.onclick=()=>{const d=new Date(currentDate);d.setDate(d.getDate()-1);location.href=`agenda.html?date=${toISO(d)}`};
next.onclick=()=>{const d=new Date(currentDate);d.setDate(d.getDate()+1);location.href=`agenda.html?date=${toISO(d)}`};
today.onclick=()=>location.href="agenda.html";

const base=new Date(currentDate);
base.setHours(0,0,0,0);
dayInfo.textContent=base.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long",year:"numeric"});

/* =========================
   CARGA CITAS
========================= */
const therapistId=auth.currentUser.uid;

const snap=await getDocs(query(
  collection(db,"appointments"),
  where("therapistId","==",therapistId),
  where("start",">=",Timestamp.fromDate(base)),
  where("start","<",Timestamp.fromDate(new Date(base.getTime()+86400000))),
  orderBy("start")
));

const byHour={};
snap.forEach(d=>byHour[d.data().start.toDate().getHours()]={...d.data(),id:d.id});

const list=document.getElementById("list");

/* =========================
   RENDER
========================= */
for(let h=9;h<21;h++){
  const s=document.createElement("div");

  if(byHour[h]){
    const a=byHour[h];
    const badges=[];

    if(a.status==="completed") badges.push(`<span class="badge done">Realizada</span>`);
    if(a.paid) badges.push(`<span class="badge paid">Pagada</span>`);
    if(a.invoiceId) badges.push(`<span class="badge invoice">Facturada</span>`);

    s.className=`slot ${a.status==="completed"?"done":"busy"}`;
    s.innerHTML=`
      <div class="time">${h}:00</div>
      <div class="meta">
        <strong>${a.patientName}</strong>
        <div class="badges">${badges.join("")}</div>
      </div>`;
    s.onclick=()=>openModal(a,h);
  }else{
    s.className="slot free";
    s.innerHTML=`<div class="time">${h}:00</div><div class="meta">Libre</div>`;
    s.onclick=()=>openModal({hour:h},h);
  }

  list.appendChild(s);
}

/* =========================
   MODAL
========================= */
let current=null;
window.closeModal=()=>modal.style.display="none";

function openModal(a,hour){
  current=a;
  modal.style.display="block";

  mTitle.textContent=a.patientName||"Nueva cita";
  mPhone.value=a.patientId||"";
  mName.value=a.patientName||"";
  mName.disabled=false;
  mModality.value=a.modality||"";
  mDone.checked=a.status==="completed";
  mPaid.checked=!!a.paid;
  mInvoiced.checked=!!a.invoiceId;
}

/* =========================
   AUTOCOMPLETE
========================= */
mPhone.addEventListener("input", async ()=>{
  const phone=mPhone.value.trim();
  mName.disabled=false;
  if(!/^\d{9}$/.test(phone)) return;

  let snap=await getDoc(doc(db,"patients",phone));
  if(!snap.exists()){
    snap=await getDoc(doc(db,"patients_normalized",phone));
  }
  if(snap.exists()){
    const d=snap.data();
    mName.value=d.fullName||[d.nombre,d.apellidos].filter(Boolean).join(" ");
    mName.disabled=true;
  }
});

/* =========================
   GUARDAR
========================= */
save.onclick=async()=>{
  const user=auth.currentUser;
  if(!user) return;

  if(current.id){
    await updateDoc(doc(db,"appointments",current.id),{
      status:mDone.checked?"completed":"scheduled",
      completedAt:mDone.checked?Timestamp.now():null,
      paid:mPaid.checked
    });
  }else{
    const start=new Date(base);start.setHours(current.hour,0,0,0);
    const end=new Date(start);end.setHours(start.getHours()+1);

    await addDoc(collection(db,"appointments"),{
      therapistId:user.uid,
      patientId:mPhone.value,
      patientName:mName.value,
      modality:mModality.value,
      start:Timestamp.fromDate(start),
      end:Timestamp.fromDate(end),
      status:"scheduled",
      paid:false,
      createdAt:serverTimestamp()
    });
  }

  location.reload();
};

/* =========================
   FACTURA
========================= */
invoice.onclick=async()=>{
  if(!current.id || current.invoiceId) return;

  const ref=await addDoc(collection(db,"invoices"),{
    therapistId:therapistId,
    appointmentId:current.id,
    patientId:mPhone.value,
    patientName:mName.value,
    amount:Number(mAmount.value),
    payment:{
      method:mPayment.value||null,
      paid:mPaid.checked
    },
    issued:true,
    issuedAt:serverTimestamp(),
    createdAt:serverTimestamp()
  });

  await updateDoc(doc(db,"appointments",current.id),{
    invoiceId:ref.id
  });

  location.reload();
};
</script>
</body>
</html>
