<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>FacturaciÃ³n de pacientes | Psicoterapia Isla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS base existente -->
  <link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-body">

<!-- MENÃš (ESTABLE, NO SE TOCA) -->
<header class="app-menu"></header>

<main class="app-container">

  <h1 class="page-title">FacturaciÃ³n de pacientes</h1>

  <!-- ======================
       SELECTOR PACIENTE
  ====================== -->
  <section class="card">
    <label>
      Selecciona un paciente
      <select id="patient-select">
        <option value="">â€” Seleccionar â€”</option>
      </select>
    </label>
  </section>

  <!-- ======================
       FACTURAS
  ====================== -->
  <section class="card">
    <h2>Facturas</h2>
    <div id="invoices-list">
      <p style="opacity:.6">Selecciona un paciente para ver sus facturas.</p>
    </div>
  </section>

</main>

<!-- ======================
     SCRIPT
====================== -->
<script type="module">
  import { requireAuth } from "./assets/js/auth.js";
  import { loadMenu } from "./assets/js/menu.js";
  import { db } from "./assets/js/firebase.js";

  import {
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  async function init() {
    const user = await requireAuth();
    await loadMenu();

    // ðŸ” SOLO ADMIN
    const meSnap = await getDocs(
      query(collection(db, "users"), where("__name__", "==", user.uid))
    );

    let isAdmin = false;
    meSnap.forEach(d => {
      if (d.data().role === "admin") isAdmin = true;
    });

    if (!isAdmin) {
      alert("Acceso solo para administradores");
      location.href = "index.html";
      return;
    }

    loadPatients();
  }

  /* ======================
     CARGAR PACIENTES
  ====================== */
  async function loadPatients() {
    const select = document.getElementById("patient-select");

    const snap = await getDocs(collection(db, "patients"));

    if (snap.empty) {
      select.innerHTML += `<option disabled>No hay pacientes</option>`;
      return;
    }

    snap.forEach(docSnap => {
      const p = docSnap.data();
      const opt = document.createElement("option");
      opt.value = docSnap.id;
      opt.textContent = `${p.nombre || ""} ${p.apellidos || ""}`.trim();
      select.appendChild(opt);
    });

    select.addEventListener("change", () => {
      if (select.value) loadInvoices(select.value);
    });
  }

  /* ======================
     CARGAR FACTURAS
  ====================== */
  async function loadInvoices(patientId) {
    const container = document.getElementById("invoices-list");
    container.innerHTML = "<p>Cargando facturasâ€¦</p>";

    const q = query(
      collection(db, "invoices"),
      where("patientId", "==", patientId)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      container.innerHTML = "<p>No hay facturas para este paciente.</p>";
      return;
    }

    container.innerHTML = "";

    snap.forEach(docSnap => {
      const inv = docSnap.data();

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <strong>Factura ${inv.invoiceNumber || "(borrador)"}</strong>
        <p>Estado: <strong>${inv.status}</strong></p>
        <p>Total: ${inv.totalAmount} â‚¬</p>
      `;

      container.appendChild(card);
    });
  }

  init();
</script>

</body>
</html>
