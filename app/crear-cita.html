<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Nueva cita</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/css/app.css">
</head>

<body class="app-layout">

<header class="app-menu"></header>

<main class="app-content">
<h1>Nueva cita</h1>

<label>Teléfono</label>
<input id="phone">

<label>Nombre</label>
<input id="name">

<label>Modalidad</label>
<select id="mod">
  <option value="">—</option>
  <option value="viladecans">Viladecans</option>
  <option value="badalona">Badalona</option>
  <option value="online">Online</option>
</select>

<label>Hora inicio</label>
<input type="time" id="start">

<label>Hora fin</label>
<input type="time" id="end">

<br><br>
<button id="save" class="btn-primary">Crear cita</button>
</main>

<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
import { auth, db } from "./assets/js/firebase.js";
import { addDoc, collection, Timestamp, serverTimestamp }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

await requireAuth();await loadMenu();

const date=new URLSearchParams(location.search).get("date");
const base=new Date(date);base.setHours(0,0,0,0);

save.onclick=async()=>{
  const [sh,sm]=start.value.split(":");
  const [eh,em]=end.value.split(":");

  const s=new Date(base);s.setHours(sh,sm);
  const e=new Date(base);e.setHours(eh,em);

  await addDoc(collection(db,"appointments"),{
    therapistId:auth.currentUser.uid,
    patientId:phone.value,
    patientName:name.value,
    modality:mod.value,
    start:Timestamp.fromDate(s),
    end:Timestamp.fromDate(e),
    status:"scheduled",
    createdAt:serverTimestamp()
  });

  location.href=`agenda-diaria.html?date=${date}`;
};
</script>
</body>
</html>
