<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Agenda diaria | Psicoterapia Isla</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="assets/css/app.css">

<style>
.wrapper{
  max-width:800px;
  margin:0 auto;
  padding:1.5rem;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
}

.date{
  font-size:1.2rem;
  font-weight:600;
}

.nav{
  display:flex;
  gap:.5rem;
}

.slot{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.75rem 1rem;
  border-radius:12px;
  margin-bottom:.5rem;
  cursor:pointer;
}

.slot.free{ background:#e5e7eb; }
.slot.busy{ background:#e6f4d7; }

.time{ font-weight:600; width:70px; }

.btn-add{
  font-size:.8rem;
  padding:.3rem .6rem;
  border-radius:8px;
}

/* MODAL */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  z-index:999;
}

.modal-card{
  background:#fff;
  max-width:420px;
  margin:10vh auto;
  padding:1.2rem;
  border-radius:16px;
}

.modal-card input,
.modal-card select{
  width:100%;
  margin:.4rem 0;
  padding:.4rem;
}

.actions{
  display:flex;
  justify-content:flex-end;
  gap:.5rem;
  margin-top:1rem;
}
</style>
</head>

<body class="app-body">
<header class="app-menu"></header>

<main class="wrapper">

  <div class="header">
    <div class="date" id="dateLabel"></div>
    <div class="nav">
      <button id="prev" class="btn-secondary">←</button>
      <button id="today" class="btn-secondary">Hoy</button>
      <button id="next" class="btn-secondary">→</button>
    </div>
  </div>

  <div id="list"></div>
</main>

<!-- MODAL CREAR CITA -->
<div id="createModal" class="modal">
  <div class="modal-card">
    <h3>Nueva cita</h3>

    <input id="cPatientPhone" placeholder="Teléfono (9 dígitos)">
    <input id="cPatientName" placeholder="Nombre">

    <input id="cService" placeholder="Servicio">

    <select id="cModality">
      <option value="">Modalidad</option>
      <option value="viladecans">Viladecans</option>
      <option value="badalona">Badalona</option>
      <option value="online">Online</option>
    </select>

    <label>Inicio</label>
    <input id="cStart" type="time">

    <label>Fin</label>
    <input id="cEnd" type="time">

    <div class="actions">
      <button onclick="createAppointment()" class="btn-primary">Crear</button>
      <button onclick="closeCreateModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- AUTH -->
<script type="module">
import { requireAuth } from "./assets/js/auth.js";
import { loadMenu } from "./assets/js/menu.js";
await requireAuth();
await loadMenu();
</script>

<!-- LÓGICA -->
<script type="module">
import { auth, db } from "./assets/js/firebase.js";
import {
  collection, query, where, getDocs,
  addDoc, Timestamp, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const therapistId = auth.currentUser.uid;
const list = document.getElementById("list");

/* ===== FECHA ===== */
let currentDate =
  new URLSearchParams(location.search).get("date")
  || new Date().toISOString().split("T")[0];

function toISO(d){
  return d.toISOString().slice(0,10);
}

function setHeader(){
  const d=new Date(currentDate);
  document.getElementById("dateLabel").textContent =
    d.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long",year:"numeric"});
}

prev.onclick=()=>{
  const d=new Date(currentDate);d.setDate(d.getDate()-1);
  location.href=`agenda-diaria.html?date=${toISO(d)}`;
};
next.onclick=()=>{
  const d=new Date(currentDate);d.setDate(d.getDate()+1);
  location.href=`agenda-diaria.html?date=${toISO(d)}`;
};
today.onclick=()=>location.href="agenda-diaria.html";

/* ===== CARGA CITAS ===== */
async function load(){
  setHeader();
  list.innerHTML="";

  const base=new Date(currentDate);
  base.setHours(0,0,0,0);

  const snap = await getDocs(query(
    collection(db,"appointments"),
    where("therapistId","==",therapistId),
    where("start",">=",Timestamp.fromDate(base)),
    where("start","<",Timestamp.fromDate(new Date(base.getTime()+86400000)))
  ));

  const byHour={};
  snap.forEach(d=>{
    byHour[d.data().start.toDate().getHours()]=d.data();
  });

  for(let h=9;h<21;h++){
    const div=document.createElement("div");

    if(byHour[h]){
      div.className="slot busy";
      div.innerHTML=`
        <div class="time">${h}:00</div>
        <div><strong>${byHour[h].patientName}</strong></div>
      `;
    }else{
      div.className="slot free";
      div.innerHTML=`
        <div class="time">${h}:00</div>
        <button class="btn-add" onclick="openCreateModal('${currentDate}',${h})">+ Crear cita</button>
      `;
    }

    list.appendChild(div);
  }
}

load();

/* ===== MODAL ===== */
window.openCreateModal=(date,hour)=>{
  window.__selectedDateISO=date;
  cStart.value=`${String(hour).padStart(2,"0")}:00`;
  cEnd.value=`${String(hour+1).padStart(2,"0")}:00`;
  createModal.style.display="block";
};
window.closeCreateModal=()=>createModal.style.display="none";

/* ===== AUTOCOMPLETE ===== */
cPatientPhone.addEventListener("input", async ()=>{
  const phone=cPatientPhone.value.trim();
  if(!/^\d{9}$/.test(phone)){ cPatientName.value=""; return; }

  let snap=await getDoc(doc(db,"patients",phone));
  if(!snap.exists()) snap=await getDoc(doc(db,"patients_normalized",phone));

  if(snap.exists()){
    const d=snap.data();
    cPatientName.value=d.fullName||`${d.nombre||""} ${d.apellidos||""}`;
    cPatientName.disabled=true;
  }else{
    cPatientName.disabled=false;
  }
});

/* ===== CREAR ===== */
window.createAppointment=async()=>{
  const user=auth.currentUser;
  if(!user) return alert("No autenticado");

  const phone=cPatientPhone.value.trim();
  const name=cPatientName.value.trim();
  const modality=cModality.value;

  if(!phone||!name||!modality) return alert("Datos incompletos");

  const base=new Date(window.__selectedDateISO);
  base.setHours(0,0,0,0);

  const [sh]=cStart.value.split(":");
  const [eh]=cEnd.value.split(":");

  const start=new Date(base); start.setHours(sh,0,0,0);
  const end=new Date(base);   end.setHours(eh,0,0,0);

  await addDoc(collection(db,"appointments"),{
    therapistId:user.uid,
    patientId:phone,
    patientName:name,
    modality,
    start:Timestamp.fromDate(start),
    end:Timestamp.fromDate(end),
    status:"scheduled",
    createdAt:Timestamp.now()
  });

  closeCreateModal();
  load();
};
</script>
</body>
</html>
